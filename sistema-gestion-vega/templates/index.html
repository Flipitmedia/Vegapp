<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n - La Vega</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="logo">ü•¨</span>
            <span class="brand-text">Sistema La Vega</span>
        </div>
        <div class="navbar-date">{{ fecha_hoy }}</div>
    </nav>

    <main class="container">
        <!-- Stats Cards -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-content">
                    <div class="stat-value">{{ pedidos_pendientes }}</div>
                    <div class="stat-label">Pedidos Pendientes</div>
                </div>
            </div>
            <div class="stat-card stat-today">
                <div class="stat-icon">üöö</div>
                <div class="stat-content">
                    <div class="stat-value">{{ pedidos_hoy }}</div>
                    <div class="stat-label">Entregas Hoy</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-value">{{ fechas_pendientes }}</div>
                    <div class="stat-label">Fechas con Pedidos</div>
                </div>
            </div>
            <div class="stat-card {% if sin_categoria > 0 %}stat-warning{% endif %}">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-value">{{ sin_categoria }}</div>
                    <div class="stat-label">Sin Categor√≠a</div>
                </div>
            </div>
        </section>

        <!-- Upload Section -->
        <section class="card upload-section">
            <h2>üì§ Importar Pedidos</h2>
            <p class="text-muted">Sube el archivo CSV exportado desde Shopify</p>
            
            <form id="upload-form" class="upload-form">
                <div class="file-input-wrapper">
                    <input type="file" id="csv-file" accept=".csv" required>
                    <label for="csv-file" class="file-label">
                        <span class="file-icon">üìÑ</span>
                        <span class="file-text">Seleccionar archivo CSV</span>
                    </label>
                    <span class="file-name" id="file-name"></span>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span>Importar</span>
                </button>
            </form>
            
            <div id="upload-result" class="upload-result hidden"></div>
        </section>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Left Column: Fechas y Descargas -->
            <section class="card">
                <h2>üìÖ Pedidos por Fecha</h2>
                <div id="fechas-list" class="fechas-list">
                    <p class="text-muted">Cargando...</p>
                </div>
            </section>

            <!-- Right Column: Categor√≠as -->
            <section class="card">
                <h2>üè∑Ô∏è Gesti√≥n de Categor√≠as</h2>
                
                <!-- Productos sin categor√≠a -->
                <div id="productos-sin-categoria" class="productos-sin-categoria">
                    <h3>Productos sin asignar</h3>
                    <div id="productos-lista" class="productos-lista">
                        <p class="text-muted">No hay productos sin categor√≠a</p>
                    </div>
                </div>

                <!-- Lista de categor√≠as -->
                <div class="categorias-section">
                    <h3>Categor√≠as disponibles</h3>
                    <div id="categorias-lista" class="categorias-lista"></div>
                    
                    <form id="nueva-categoria-form" class="nueva-categoria-form">
                        <input type="text" id="nueva-categoria" placeholder="Nueva categor√≠a..." required>
                        <button type="submit" class="btn btn-small">+ Agregar</button>
                    </form>
                </div>
            </section>
        </div>

        <!-- Detalle de Pedidos (Modal/Expandible) -->
        <section class="card" id="detalle-section" style="display: none;">
            <div class="detalle-header">
                <h2>üìã Pedidos del <span id="detalle-fecha"></span></h2>
                <button class="btn btn-small" onclick="cerrarDetalle()">‚úï Cerrar</button>
            </div>
            <div id="pedidos-detalle" class="pedidos-detalle"></div>
        </section>
    </main>

    <!-- Modal para asignar categor√≠a -->
    <div id="modal-categoria" class="modal hidden">
        <div class="modal-content">
            <h3>Asignar Categor√≠a</h3>
            <p id="modal-producto-nombre"></p>
            <form id="asignar-form">
                <input type="hidden" id="modal-producto" name="producto">
                <select id="modal-categoria-select" name="categoria_id" required>
                    <option value="">Seleccionar categor√≠a...</option>
                </select>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let categorias = [];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            cargarCategorias();
            cargarFechas();
            cargarProductosSinCategoria();
            
            // Event listeners
            document.getElementById('upload-form').addEventListener('submit', handleUpload);
            document.getElementById('nueva-categoria-form').addEventListener('submit', handleNuevaCategoria);
            document.getElementById('asignar-form').addEventListener('submit', handleAsignarCategoria);
            
            // File input
            document.getElementById('csv-file').addEventListener('change', (e) => {
                const fileName = e.target.files[0]?.name || '';
                document.getElementById('file-name').textContent = fileName;
            });
        });

        // ============================================
        // API CALLS
        // ============================================
        async function cargarCategorias() {
            const res = await fetch('/api/categorias');
            categorias = await res.json();
            renderCategorias();
            actualizarSelectCategorias();
        }

        async function cargarFechas() {
            const res = await fetch('/api/fechas-pendientes');
            const fechas = await res.json();
            renderFechas(fechas);
        }

        async function cargarProductosSinCategoria() {
            const res = await fetch('/api/productos-sin-categoria');
            const productos = await res.json();
            renderProductosSinCategoria(productos);
        }

        async function cargarPedidosFecha(fecha) {
            const res = await fetch(`/api/pedidos?fecha=${fecha}&status=pendiente`);
            const pedidos = await res.json();
            renderPedidosDetalle(fecha, pedidos);
        }

        // ============================================
        // HANDLERS
        // ============================================
        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('csv-file');
            const resultDiv = document.getElementById('upload-result');
            
            if (!fileInput.files[0]) return;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            resultDiv.className = 'upload-result loading';
            resultDiv.innerHTML = '‚è≥ Procesando...';
            
            try {
                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.className = 'upload-result success';
                    resultDiv.innerHTML = `
                        ‚úÖ Importaci√≥n completada<br>
                        <strong>${data.nuevos}</strong> pedidos nuevos<br>
                        ${data.duplicados > 0 ? `<small>${data.duplicados} duplicados ignorados</small><br>` : ''}
                        ${data.sin_fecha > 0 ? `<small>‚ö†Ô∏è ${data.sin_fecha} sin fecha de entrega</small>` : ''}
                    `;
                    
                    // Recargar datos
                    cargarFechas();
                    cargarProductosSinCategoria();
                    setTimeout(() => location.reload(), 2000);
                } else {
                    throw new Error(data.detail || 'Error desconocido');
                }
            } catch (error) {
                resultDiv.className = 'upload-result error';
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function handleNuevaCategoria(e) {
            e.preventDefault();
            const input = document.getElementById('nueva-categoria');
            const nombre = input.value.trim();
            
            if (!nombre) return;
            
            const formData = new FormData();
            formData.append('nombre', nombre);
            
            const res = await fetch('/api/categorias', {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                input.value = '';
                cargarCategorias();
            } else {
                alert('Error al crear categor√≠a');
            }
        }

        async function handleAsignarCategoria(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const res = await fetch('/api/asignar-categoria', {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                cerrarModal();
                cargarProductosSinCategoria();
                location.reload();
            }
        }

        // ============================================
        // RENDERS
        // ============================================
        function renderCategorias() {
            const container = document.getElementById('categorias-lista');
            container.innerHTML = categorias.map(cat => `
                <div class="categoria-tag">${cat.nombre}</div>
            `).join('');
        }

        function renderFechas(fechas) {
            const container = document.getElementById('fechas-list');
            
            if (fechas.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay pedidos pendientes</p>';
                return;
            }
            
            const hoy = new Date().toISOString().split('T')[0];
            
            container.innerHTML = fechas.map(f => {
                const esHoy = f.fecha === hoy;
                return `
                    <div class="fecha-item ${esHoy ? 'fecha-hoy' : ''}">
                        <div class="fecha-info">
                            <span class="fecha-date">${formatFecha(f.fecha)}</span>
                            <span class="fecha-count">${f.cantidad} pedido${f.cantidad > 1 ? 's' : ''}</span>
                            ${esHoy ? '<span class="badge-hoy">HOY</span>' : ''}
                        </div>
                        <div class="fecha-actions">
                            <button class="btn btn-small" onclick="verPedidos('${f.fecha}')">üëÅÔ∏è Ver</button>
                            <a href="/descargar/lista-compras/${f.fecha}" class="btn btn-small btn-success">üõí Compras</a>
                            <a href="/descargar/pedidos-armado/${f.fecha}" class="btn btn-small btn-info">üì¶ Armado</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProductosSinCategoria(productos) {
            const container = document.getElementById('productos-lista');
            
            if (productos.length === 0) {
                container.innerHTML = '<p class="text-muted">‚úÖ Todos los productos tienen categor√≠a</p>';
                return;
            }
            
            container.innerHTML = productos.map(prod => `
                <div class="producto-item">
                    <span class="producto-nombre">${prod}</span>
                    <button class="btn btn-small" onclick="abrirModalCategoria('${escapeHtml(prod)}')">
                        Asignar
                    </button>
                </div>
            `).join('');
        }

        function renderPedidosDetalle(fecha, pedidos) {
            const section = document.getElementById('detalle-section');
            const container = document.getElementById('pedidos-detalle');
            document.getElementById('detalle-fecha').textContent = formatFecha(fecha);
            
            container.innerHTML = pedidos.map(p => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <strong>${p.order_number}</strong>
                        <span class="pedido-cliente">${p.nombre_cliente || 'Sin nombre'}</span>
                        <span class="pedido-comuna badge">${p.comuna || 'Sin comuna'}</span>
                    </div>
                    ${p.direccion ? `<div class="pedido-direccion">üìç ${p.direccion}</div>` : ''}
                    <ul class="pedido-items">
                        ${p.items.map(item => `
                            <li><strong>${item.cantidad}x</strong> ${item.producto}</li>
                        `).join('')}
                    </ul>
                    <div class="pedido-actions">
                        <button class="btn btn-small btn-success" onclick="completarPedido(${p.id})">
                            ‚úÖ Completado
                        </button>
                    </div>
                </div>
            `).join('');
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        function actualizarSelectCategorias() {
            const select = document.getElementById('modal-categoria-select');
            select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>' +
                categorias.map(cat => `<option value="${cat.id}">${cat.nombre}</option>`).join('');
        }

        // ============================================
        // ACCIONES
        // ============================================
        function verPedidos(fecha) {
            cargarPedidosFecha(fecha);
        }

        function cerrarDetalle() {
            document.getElementById('detalle-section').style.display = 'none';
        }

        function abrirModalCategoria(producto) {
            document.getElementById('modal-producto').value = producto;
            document.getElementById('modal-producto-nombre').textContent = producto;
            document.getElementById('modal-categoria').classList.remove('hidden');
        }

        function cerrarModal() {
            document.getElementById('modal-categoria').classList.add('hidden');
        }

        async function completarPedido(id) {
            if (!confirm('¬øMarcar este pedido como completado?')) return;
            
            await fetch(`/api/pedidos/${id}/completar`, { method: 'POST' });
            location.reload();
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function formatFecha(fecha) {
            const d = new Date(fecha + 'T12:00:00');
            const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${dias[d.getDay()]} ${d.getDate()} ${meses[d.getMonth()]}`;
        }

        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
    </script>
</body>
</html>
